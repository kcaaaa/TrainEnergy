# 多站能耗对比模块设计文档

## 1. 功能概述
多站能耗对比模块用于实现不同高铁站之间的能耗数据对比分析，支持用户选择不同维度进行数据对比，包括不同时间维度（日、周、月、季、年）、不同能耗类型和不同区域的能耗数据对比。通过可视化图表展示对比结果，帮助管理者全面了解各站能耗情况，找出能耗差异，制定针对性节能策略。

### 1.1 模式区分与展示原则
- **入口位置**：右上角提供“单站分析 / 多站分析”切换；切换后立即刷新可见组件与数据源。
- **多站模式可见性**：仅展示跨站聚合、对比、排行等组件；隐藏单站专属的实时监控、单站设备详情等入口。
- **单站模式隔离**：从多站切换到单站时跳转/加载单站模块，并清空多站的站点列表、对比指标缓存，避免交叉污染。
- **状态保持**：模式状态写入会话存储，刷新后保留最近一次选择；切换时重置筛选条件（站点、时间维度、能耗类型、对比指标）。
- **权限校验**：入口与接口均基于角色控制（超级管理员/全站管理员/单站管理员），无权限的模式入口置灰或不展示。

## 2. 输入/输出示例
### 2.1 输入
| 输入项 | 描述 | 数据类型 | 约束条件 |
|--------|------|----------|----------|
| 选择站点 | 待对比的高铁站列表 | 多选 | 至少选择2个站点 |
| 对比维度 | 时间维度（日/周/月/季/年） | 单选 | 必选 |
| 能耗类型 | 待对比的能耗类型（电/水/气/热力） | 多选 | 至少选择1种 |
| 对比指标 | 对比的能耗指标（总能耗/人均能耗/单位面积能耗/单位客运量能耗） | 单选 | 必选 |
| 时间范围 | 对比的起始和结束时间 | 日期区间 | 必选 |

### 2.2 输出
| 输出项 | 描述 | 数据类型 | 展示形式 |
|--------|------|----------|----------|
| 对比图表 | 多站能耗对比的可视化图表 | 图表 | 柱状图/折线图/雷达图 |
| 对比数据表格 | 详细的多站能耗对比数据 | 表格 | 可排序、可导出 |
| 能耗差异分析 | 各站能耗差异的分析结果 | 文本 | 差异百分比、排名等 |
| 节能潜力提示 | 基于对比结果的节能潜力提示 | 文本 | 节能建议 |

## 3. 功能逻辑详细描述

### 3.1 多站选择逻辑
1. 用户可从站点列表中选择多个高铁站进行对比
2. 支持按区域、规模等条件筛选站点
3. 已选择站点显示在已选列表中，支持移除操作
4. 最多支持选择10个站点同时对比

### 3.2 对比维度选择逻辑
1. 提供日、周、月、季、年五种时间维度选项
2. 选择不同时间维度时，时间范围控件自适应调整（如选择日维度时显示具体日期选择器，选择年维度时显示年份选择器）
3. 时间范围默认显示最近30天数据

### 3.3 能耗类型选择逻辑
1. 支持同时选择多种能耗类型进行对比
2. 选择不同能耗类型时，图表会动态更新以区分展示不同类型数据
3. 提供全选/取消全选功能

### 3.4 对比指标计算逻辑
- **总能耗**：所选时间范围内各站的能耗总量累加
- **人均能耗**：总能耗 / 站内人员数量
- **单位面积能耗**：总能耗 / 站房总面积
- **单位客运量能耗**：总能耗 / 客运量

### 3.5 数据对比分析逻辑
1. 对所选站点的相同指标进行横向对比
2. 计算各站之间的能耗差异百分比
3. 生成能耗排名（按所选指标从高到低或从低到高排序）
4. 识别能耗异常偏高或偏低的站点

### 3.6 可视化展示逻辑
1. 根据选择的维度自动调整图表类型（默认柱状图）
2. 支持用户手动切换图表类型（柱状图、折线图、雷达图）
3. 图表支持交互操作（如悬停显示详细数据、点击查看单站详情）
4. 支持图表放大/缩小、导出功能

### 3.7 节能潜力分析逻辑
1. 基于对比结果，识别能耗较高的站点
2. 与同类型站点的平均水平对比，计算节能潜力
3. 提供针对性的节能建议（如设备优化、管理改进等）

## 4. 数据流向图

```
[用户选择站点、对比维度、能耗类型、时间范围] → [前端请求参数校验] → [调用后端多站对比数据接口] → [后端获取各站能耗数据] → [后端进行数据对比计算] → [返回对比结果数据] → [前端数据处理] → [图表渲染展示] → [生成对比分析报告]
```

## 5. 功能点击交互流程

1. **进入多站对比页面**
   - 用户从导航菜单点击"多站能耗对比"选项
   - 页面加载默认对比维度（日）和时间范围（最近30天）

2. **选择对比站点**
   - 点击站点选择框，弹出站点选择面板
   - 用户通过搜索或筛选选择待对比站点
   - 已选站点显示在选择框下方，支持移除单个站点

3. **选择对比维度和时间范围**
   - 点击时间维度下拉菜单，选择日/周/月/季/年
   - 根据选择的维度，时间范围选择器自动调整
   - 点击时间范围选择器，选择起始和结束时间

4. **选择能耗类型和对比指标**
   - 在能耗类型多选框中选择待对比的能耗类型
   - 在对比指标下拉菜单中选择对比指标（总能耗/人均能耗等）

5. **执行对比分析**
   - 点击"开始对比"按钮
   - 页面显示加载状态
   - 后台进行数据处理和对比计算

6. **查看对比结果**
   - 页面加载完成后，显示对比图表和数据表格
   - 用户可鼠标悬停在图表上查看详细数据
   - 支持切换图表类型查看不同展示效果

7. **导出对比数据**
   - 点击"导出数据"按钮
   - 系统生成Excel或CSV格式的对比数据文件
   - 文件下载到本地

8. **查看详细分析报告**
   - 点击"生成分析报告"按钮
   - 系统根据对比结果生成详细的分析报告
   - 报告包含各站对比数据、能耗差异分析、节能潜力等内容

9. **模式切换与可见性（右上角）**
   - 选择“多站分析”：保留当前多站筛选与图表；隐藏单站入口与单站专属组件。
   - 选择“单站分析”：跳转到单站模块，清空多站筛选缓存并隐藏多站组件；单站模式下不会展示跨站对比与排名。
   - 切换时弹出轻提示“已切换至单站/多站模式，筛选已重置”并触发加载动画。

## 6. 功能字段详细说明

| 字段名称 | 字段类型 | 长度 | 是否必填 | 约束条件 | 描述 |
|----------|----------|------|----------|----------|------|
| 站点ID | String | 32 | 是 | 唯一标识符 | 高铁站唯一标识 |
| 站点名称 | String | 50 | 是 | 唯一 | 高铁站名称 |
| 时间维度 | String | 10 | 是 | 日/周/月/季/年 | 对比的时间维度 |
| 开始时间 | Date | - | 是 | 小于结束时间 | 对比的起始时间 |
| 结束时间 | Date | - | 是 | 大于开始时间 | 对比的结束时间 |
| 能耗类型 | Array | - | 是 | 至少1个 | 待对比的能耗类型 |
| 对比指标 | String | 20 | 是 | 总能耗/人均能耗/单位面积能耗/单位客运量能耗 | 对比的能耗指标 |
| 能耗值 | Number | - | 是 | 大于等于0 | 能耗数据值 |
| 单位 | String | 10 | 是 | - | 能耗值的单位 |
| 差异百分比 | Number | - | 否 | - | 与基准站点的能耗差异百分比 |
| 排名 | Integer | - | 否 | 大于等于1 | 能耗排名 |

## 7. 异常情况处理

| 异常场景 | 异常描述 | 处理方式 | 系统反馈 |
|----------|----------|----------|----------|
| 未选择站点 | 用户未选择任何站点进行对比 | 前端校验 | 提示"请至少选择2个站点进行对比" |
| 选择站点不足 | 用户仅选择1个站点进行对比 | 前端校验 | 提示"请至少选择2个站点进行对比" |
| 选择站点过多 | 用户选择超过10个站点进行对比 | 前端校验 | 提示"最多只能选择10个站点进行对比" |
| 未选择时间范围 | 用户未选择对比的时间范围 | 前端校验 | 提示"请选择对比的时间范围" |
| 时间范围不合法 | 开始时间大于结束时间 | 前端校验 | 提示"开始时间不能大于结束时间" |
| 未选择能耗类型 | 用户未选择能耗类型 | 前端校验 | 提示"请至少选择1种能耗类型" |
| 数据加载失败 | 后端返回数据失败 | 错误处理 | 提示"数据加载失败，请稍后重试" |
| 无对比数据 | 所选条件下没有可对比的数据 | 数据处理 | 提示"当前选择条件下无对比数据" |
| 部分站点数据缺失 | 部分选择的站点无数据 | 数据处理 | 提示"部分站点暂无数据"，并在图表中标记 |
| 图表渲染失败 | 图表渲染过程中出现错误 | 错误处理 | 提示"图表渲染失败，请刷新页面重试" |

## 8. 性能要求

| 性能指标 | 要求 | 说明 |
|----------|------|------|
| 页面加载时间 | ≤3秒 | 页面初始化加载完成时间 |
| 数据请求响应时间 | ≤2秒 | 从发送请求到数据返回的时间 |
| 图表渲染时间 | ≤1秒 | 从数据返回至图表渲染完成的时间 |
| 支持同时对比站点数 | 10个 | 最多支持同时对比10个站点 |
| 支持数据量 | 10万条 | 单页面可展示的历史对比数据量 |
| 并发用户数 | 1000 | 系统支持的并发用户数量 |

## 9. 安全要求

| 安全项 | 要求 | 说明 |
|--------|------|------|
| 权限控制 | 基于角色的访问控制 | 仅允许具有权限的用户访问多站对比功能 |
| 数据加密 | 传输加密 | 数据传输过程中采用HTTPS加密 |
| 数据脱敏 | 敏感数据处理 | 对涉及敏感信息的数据进行脱敏处理 |
| 操作日志 | 记录用户操作 | 记录用户的查询、导出等操作日志 |
| SQL注入防护 | 参数化查询 | 防止SQL注入攻击 |
| XSS防护 | 输入验证和输出编码 | 防止跨站脚本攻击 |
- **角色与演示账号**：超级管理员 admin/123456 可访问单站/多站全部功能；全站管理员 Allsite/123456 可访问多站与全站配置，并可查看任意站点单站数据；单站管理员（智能生成，如 station01/123456）仅可见单站模式且绑定所属站点。
- **数据范围控制**：单站管理员的接口请求必须携带绑定的站点ID并在后端校验，禁止跨站访问；全站/超级管理员可选择任意站点或多站聚合。

## 10. 测试点

| 测试项 | 测试内容 | 期望结果 |
|--------|----------|----------|
| 站点选择功能 | 验证站点选择、移除、筛选功能 | 能正常选择、移除站点，筛选功能有效 |
| 时间维度选择 | 验证不同时间维度的选择和时间范围自适应 | 时间范围控件根据选择的维度正确调整 |
| 能耗类型选择 | 验证能耗类型的多选和全选功能 | 能正常选择多种能耗类型，全选/取消全选有效 |
| 对比指标选择 | 验证不同对比指标的计算逻辑 | 不同指标下的对比结果正确 |
| 对比分析功能 | 验证多站对比的计算逻辑和结果 | 对比结果准确，差异计算正确 |
| 图表展示功能 | 验证图表的渲染和交互功能 | 图表渲染正常，交互操作有效 |
| 数据导出功能 | 验证对比数据的导出功能 | 能成功导出Excel/CSV文件，数据完整 |
| 异常情况处理 | 验证各种异常场景的处理 | 异常提示准确，系统处理合理 |
| 性能测试 | 验证页面加载、数据请求、图表渲染的性能 | 满足性能要求 |
| 安全测试 | 验证权限控制、数据加密等安全措施 | 安全措施有效 |
| 模式切换可见性 | 验证单站/多站切换后组件与菜单可见性正确 | 单站模式隐藏多站组件，多站模式隐藏单站组件 |
| 角色可见性 | 验证不同角色的模式入口与数据范围 | admin/Allsite 可切换；单站账号仅单站，跨站请求被拒 |
| 状态保持与重置 | 切换模式后刷新页面，筛选条件重置且模式保持 | 模式存储生效，筛选重置无残留 |

## 11. 依赖关系

| 依赖项 | 描述 | 依赖类型 |
|--------|------|----------|
| 站点基础信息 | 高铁站的基本信息数据 | 数据依赖 |
| 能耗数据 | 各站点的能耗数据 | 数据依赖 |
| 统计分析服务 | 多站对比的统计分析服务 | 服务依赖 |
| 图表组件 | 用于展示对比结果的图表组件 | 组件依赖 |
| 文件导出服务 | 用于导出对比数据的服务 | 服务依赖 |

## 12. 功能变更记录

| 版本号 | 变更日期 | 变更内容 | 变更人 | 审核人 |
|--------|----------|----------|--------|--------|
| V1.0 | 2023-11-15 | 初始版本 | 张工 | 李工 |
| V1.1 | 2023-11-20 | 增加人均能耗和单位客运量能耗对比指标 | 王工 | 赵工 |
| V1.2 | 2023-11-25 | 优化图表渲染性能，支持更多图表类型 | 刘工 | 陈工 |
| V1.3 | 2025-12-24 | 增加单站/多站模式切换入口与可见性规则，补充角色与演示账号、状态保持与重置，以及对应测试用例 | 全流程产品技术负责人 |  |

## 13. 附加说明

1. 多站对比功能支持保存用户的常用对比配置，方便下次直接使用
2. 支持设置基准站点，所有站点的数据都与基准站点进行对比
3. 对比结果可生成可视化分析报告，支持分享给其他用户
4. 系统根据历史对比数据，自动识别能耗异常站点并进行预警